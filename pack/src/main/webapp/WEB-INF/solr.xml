<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>
    <bean id="org.sakaiproject.search.api.SearchService"
          class="uk.ac.ox.oucs.search.solr.SolrSearchService" init-method="init">
        <property name="triggerFunctions">
            <list/>
        </property>
        <property name="notificationService" ref="org.sakaiproject.event.api.NotificationService"/>
        <property name="searchIndexBuilder" ref="org.sakaiproject.search.api.SearchIndexBuilder"/>
        <property name="solrServer" ref="solrLookupServer"/>
        <property name="searchItemFilter">
            <bean class="uk.ac.ox.oucs.search.solr.filter.SecuritySearchFilter">
                <property name="contentProducerFactory" ref="uk.ac.ox.oucs.search.solr.ContentProducerFactory"/>
            </bean>
        </property>
        <property name="contentProducerFactory" ref="uk.ac.ox.oucs.search.solr.ContentProducerFactory"/>
    </bean>

    <bean id="org.sakaiproject.search.api.SearchIndexBuilder"
          class="uk.ac.ox.oucs.search.solr.SolrSearchIndexBuilder">
        <property name="siteService" ref="org.sakaiproject.site.api.SiteService"/>
        <property name="solrServer" ref="solrIndexingServer"/>
        <property name="searchToolRequired">
            <bean factory-bean="org.sakaiproject.component.api.ServerConfigurationService" factory-method="getBoolean">
                <constructor-arg value="search.tool.required"/>
                <constructor-arg value="true"/>
            </bean>
        </property>
        <property name="ignoreUserSites">
            <bean factory-bean="org.sakaiproject.component.api.ServerConfigurationService" factory-method="getBoolean">
                <constructor-arg value="search.usersites.ignored"/>
                <constructor-arg value="true"/>
            </bean>
        </property>
        <property name="contentProducerFactory" ref="uk.ac.ox.oucs.search.solr.ContentProducerFactory"/>
        <property name="indexingExecutor" ref="solrIndexingExecutor"/>
    </bean>

    <bean id="uk.ac.ox.oucs.search.solr.ContentProducerFactory"
          class="uk.ac.ox.oucs.search.solr.ContentProducerFactory"/>

    <bean id="solrLookupServer" class="org.apache.solr.client.solrj.impl.HttpSolrServer">
        <constructor-arg>
            <bean factory-bean="org.sakaiproject.component.api.ServerConfigurationService" factory-method="getString">
                <constructor-arg value="solr.server"/>
            </bean>
        </constructor-arg>
    </bean>
    <alias alias="solrIndexingServer" name="solrLookupServer"/>

    <!-- Executor responsible for handling heavy requests toward solr -->
    <!--
        The maxPoolSize has to be set to one to avoid concurrency issues
    -->
    <bean id="solrIndexingExecutor" class="org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor">
        <property name="corePoolSize" value="0"/>
        <property name="maxPoolSize" value="1"/>
        <property name="keepAliveSeconds" value="30"/>
    </bean>
</beans>
